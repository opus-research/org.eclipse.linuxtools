<?xml version="1.0" encoding="UTF-8"?>
<!-- ***************************************************************************
* Copyright (c) 2013 École Polytechnique de Montréal
*
* All rights reserved. This program and the accompanying materials are
* made available under the terms of the Eclipse Public License v1.0 which
* accompanies this distribution, and is available at
* http://www.eclipse.org/legal/epl-v10.html
*
* Contributors:
* 	Florian Wininger - Initial API and implementation
*************************************************************************** -->
<tmfxml xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="stateprovider.xsd">

	<stateProvider analysisId="polymtl.kernel.sp" version="1">
		<head>
			<traceType id="org.eclipse.linuxtools.lttng2.kernel.tracetype" />
			<label value="Xml kernel State System" />
		</head>
		<!-- StateValues -->
		<definedValue name="CPU_STATUS_IDLE" value="0" />
		<definedValue name="CPU_STATUS_RUN_USERMODE" value="1" />
		<definedValue name="CPU_STATUS_RUN_SYSCALL" value="2" />
		<definedValue name="CPU_STATUS_IRQ" value="3" />
		<definedValue name="CPU_STATUS_SOFTIRQ" value="4" />

		<definedValue name="PROCESS_STATUS_UNKNOWN" value="0" />
		<definedValue name="PROCESS_STATUS_WAIT_BLOCKED" value="1" />
		<definedValue name="PROCESS_STATUS_RUN_USERMODE" value="2" />
		<definedValue name="PROCESS_STATUS_RUN_SYSCALL" value="3" />
		<definedValue name="PROCESS_STATUS_INTERRUPTED" value="4" />
		<definedValue name="PROCESS_STATUS_WAIT_FOR_CPU" value="5" />

		<definedValue name="SOFT_IRQ_RAISED" value="-2" />

		<!-- Shortcut Variables -->
		<location id="CurrentThread">
			<constant value="Threads" />
			<query>
				<constant value="CPUs" />
				<eventField name="cpu" />
				<constant value="Current_thread" />
			</query>
		</location>
		<location id="CurrentCPU">
			<constant value="CPUs" />
			<eventField name="cpu" />
		</location>
		<location id="CurrentIRQ">
			<constant value="Resources"/>
			<constant value="IRQs"/>
			<eventField name="irq"/>
		</location>
		<location id="CurrentSoftIRQ">
			<constant value="Resources" />
			<constant value="Soft_IRQs" />
			<eventField name="vec" />
		</location>
		<location id="newCurrentThread">
			<constant value="Threads" />
			<eventField name="next_tid" />
		</location>

		<!-- case 1 : exit_syscall : Fields: int64 ret -->
		<eventHandler eventName="exit_syscall">
			<stateChange>
				<locationName value="CurrentThread" />
				<constant value="System_call" />
				<stateValue type="null" />
			</stateChange>
			<stateChange>
				<locationName value="CurrentThread" />
				<constant value="Status" />
				<stateValue int="$PROCESS_STATUS_RUN_USERMODE" />
			</stateChange>
			<stateChange>
				<locationName value="CurrentCPU" />
				<constant value="Status" />
				<stateValue int="$CPU_STATUS_RUN_USERMODE" />
			</stateChange>
		</eventHandler>
		<!-- case 2 : irq_handler_entry : Fields: int32 irq, string name -->
		<eventHandler eventName="irq_handler_entry">
			<stateChange>
				<locationName value="CurrentIRQ" />
				<stateValue eventField="cpu" />
			</stateChange>
			<stateChange>
				<locationName value="CurrentThread" />
				<constant value="Status" />
				<stateValue int="$PROCESS_STATUS_INTERRUPTED" />
			</stateChange>
			<stateChange>
				<locationName value="CurrentCPU" />
				<constant value="Status" />
				<stateValue int="$CPU_STATUS_IRQ" />
			</stateChange>
		</eventHandler>
		<!-- case 3 : irq_handler_exit : Fields: int32 irq, int32 ret -->
		<eventHandler eventName="irq_handler_exit">
			<stateChange>
				<locationName value="CurrentIRQ" />
				<stateValue type="null" />
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<locationName value="CurrentThread" />
						<constant value="System_call" />
						<stateValue type="null" />
					</condition>
				</if>
				<then>
					<locationName value="CurrentThread" />
					<constant value="Status" />
					<stateValue int="$PROCESS_STATUS_RUN_USERMODE" />
				</then>
				<else>
					<locationName value="CurrentThread" />
					<constant value="Status" />
					<stateValue int="$PROCESS_STATUS_RUN_SYSCALL" />
				</else>
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<locationName value="CurrentThread" />
						<constant value="System_call" />
						<stateValue type="null" />
					</condition>
				</if>
				<then>
					<locationName value="CurrentCPU" />
					<constant value="Status" />
					<stateValue int="$CPU_STATUS_RUN_USERMODE" />
				</then>
				<else>
					<locationName value="CurrentCPU" />
					<constant value="Status" />
					<stateValue int="$CPU_STATUS_RUN_SYSCALL" />
				</else>
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<locationName value="CurrentCPU" />
						<constant value="Current_thread" />
						<stateValue type="null" />
					</condition>
				</if>
				<then>
					<locationName value="CurrentCPU" />
					<constant value="Status" />
					<stateValue int="$CPU_STATUS_IDLE" />
				</then>
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<locationName value="CurrentCPU" />
						<constant value="Current_thread" />
						<stateValue int="0" />
					</condition>
				</if>
				<then>
					<locationName value="CurrentCPU" />
					<constant value="Status" />
					<stateValue int="$CPU_STATUS_IDLE" />
				</then>
			</stateChange>
		</eventHandler>
		<!-- case 4 : softirq_entry : Fields: int32 vec -->
		<eventHandler eventName="softirq_entry">
			<stateChange>
				<locationName value="CurrentSoftIRQ" />
				<stateValue eventField="cpu" />
			</stateChange>
			<stateChange>
				<locationName value="CurrentThread" />
				<constant value="Status" />
				<stateValue int="$PROCESS_STATUS_INTERRUPTED" />
			</stateChange>
			<stateChange>
				<locationName value="CurrentCPU" />
				<constant value="Status" />
				<stateValue int="$CPU_STATUS_SOFTIRQ" />
			</stateChange>
		</eventHandler>
		<!-- case 5 : softirq_exit : Fields: int32 vec -->
		<eventHandler eventName="softirq_exit">
			<stateChange>
				<locationName value="CurrentSoftIRQ" />
				<stateValue type="null" />
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<locationName value="CurrentThread" />
						<constant value="System_call" />
						<stateValue type="null" />
					</condition>
				</if>
				<then>
					<locationName value="CurrentThread" />
					<constant value="Status" />
					<stateValue int="$PROCESS_STATUS_RUN_USERMODE" />
				</then>
				<else>
					<locationName value="CurrentThread" />
					<constant value="Status" />
					<stateValue int="$PROCESS_STATUS_RUN_SYSCALL" />
				</else>
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<locationName value="CurrentThread" />
						<constant value="System_call" />
						<stateValue type="null" />
					</condition>
				</if>
				<then>
					<locationName value="CurrentCPU" />
					<constant value="Status" />
					<stateValue int="$CPU_STATUS_RUN_USERMODE" />
				</then>
				<else>
					<locationName value="CurrentCPU" />
					<constant value="Status" />
					<stateValue int="$CPU_STATUS_RUN_SYSCALL" />
				</else>
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<locationName value="CurrentCPU" />
						<constant value="Current_thread" />
						<stateValue type="null" />
					</condition>
				</if>
				<then>
					<locationName value="CurrentCPU" />
					<constant value="Status" />
					<stateValue int="$CPU_STATUS_IDLE" />
				</then>
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<locationName value="CurrentCPU" />
						<constant value="Current_thread" />
						<stateValue int="0" />
					</condition>
				</if>
				<then>
					<locationName value="CurrentCPU" />
					<constant value="Status" />
					<stateValue int="$CPU_STATUS_IDLE" />
				</then>
			</stateChange>
		</eventHandler>
		<!-- case 6 : softirq_raise : Fields: int32 vec -->
		<eventHandler eventName="softirq_raise">
			<stateChange>
				<locationName value="CurrentSoftIRQ" />
				<stateValue int="$SOFT_IRQ_RAISED" />
			</stateChange>
		</eventHandler>
		<!-- case 7 : sched_switch : Fields: string prev_comm, int32 prev_tid,
			int32 prev_prio, int64 prev_state, string next_comm, int32 next_tid, int32
			next_prio -->
		<eventHandler eventName="sched_switch">
			<stateChange>
				<if>
					<condition>
						<field name="prev_state" />
						<stateValue long="0" />
					</condition>
				</if>
				<then>
					<constant value="Threads" />
					<eventField name="prev_tid" />
					<constant value="Status" />
					<stateValue int="$PROCESS_STATUS_WAIT_FOR_CPU" />
				</then>
				<else>
					<constant value="Threads" />
					<eventField name="prev_tid" />
					<constant value="Status" />
					<stateValue int="$PROCESS_STATUS_WAIT_BLOCKED" />
				</else>
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<locationName value="newCurrentThread" />
						<constant value="System_call" />
						<stateValue type="null" />
					</condition>
				</if>
				<then>
					<locationName value="newCurrentThread" />
					<constant value="Status" />
					<stateValue int="$PROCESS_STATUS_RUN_USERMODE" />
				</then>
				<else>
					<locationName value="newCurrentThread" />
					<constant value="Status" />
					<stateValue int="$PROCESS_STATUS_RUN_SYSCALL" />
				</else>
			</stateChange>
			<stateChange>
				<locationName value="newCurrentThread" />
				<constant value="Exec_name" />
				<stateValue eventField="next_comm" />
			</stateChange>
			<stateChange>
				<locationName value="CurrentCPU" />
				<constant value="Current_thread" />
				<stateValue eventField="next_tid" forcedType="int" />
			</stateChange>
			<stateChange>
				<if>
					<not>
						<condition>
							<field name="next_tid" />
							<stateValue long="0" />
						</condition>
					</not>
				</if>
				<then>
					<if>
						<condition>
							<locationName value="newCurrentThread" />
							<constant value="System_call" />
							<stateValue type="null" />
						</condition>
					</if>
					<then>
						<locationName value="CurrentCPU" />
						<constant value="Status" />
						<stateValue int="$CPU_STATUS_RUN_USERMODE" />
					</then>
					<else>
						<locationName value="CurrentCPU" />
						<constant value="Status" />
						<stateValue int="$CPU_STATUS_RUN_SYSCALL" />
					</else>
				</then>
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<field name="next_tid" />
						<stateValue long="0" />
					</condition>
				</if>
				<then>
					<locationName value="CurrentCPU" />
					<constant value="Status" />
					<stateValue int="$CPU_STATUS_IDLE" />
				</then>
			</stateChange>
		</eventHandler>
		<!-- case 8 : sched_process_fork : Fields: string parent_comm, int32 parent_tid,
			string child_comm, int32 child_tid -->
		<eventHandler eventName="sched_process_fork">
			<stateChange>
				<constant value="Threads" />
				<eventField name="child_tid" />
				<constant value="PPID" />
				<stateValue eventField="parent_tid" forcedType="int" />
			</stateChange>
			<stateChange>
				<constant value="Threads" />
				<eventField name="child_tid" />
				<constant value="Exec_name" />
				<stateValue eventField="child_comm" />
			</stateChange>
			<stateChange>
				<constant value="Threads" />
				<eventField name="child_tid" />
				<constant value="Status" />
				<stateValue int="$PROCESS_STATUS_WAIT_FOR_CPU" />
			</stateChange>
			<stateChange>
				<constant value="Threads" />
				<eventField name="child_tid" />
				<constant value="System_call" />
				<stateValue type="query">
					<constant value="Threads" />
					<eventField name="parent_tid" />
					<constant value="System_call" />
				</stateValue>
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<constant value="Threads" />
						<eventField name="child_tid" />
						<constant value="System_call" />
						<stateValue type="null" />
					</condition>
				</if>
				<then>
					<constant value="Threads" />
					<eventField name="child_tid" />
					<constant value="System_call" />
					<stateValue string="sys_clone" />
				</then>
			</stateChange>
		</eventHandler>
		<!-- case 10 : sched_process_free : Fields: string parent_comm, int32 parent_tid,
			string child_comm, int32 child_tid -->
		<eventHandler eventName="sched_process_free">
			<stateChange>
				<constant value="Threads" />
				<eventField name="tid" />
				<stateValue type="delete" />
			</stateChange>
		</eventHandler>
		<!-- case 11 : lttng_statedump_process_state : Fields: int32 type, int32
			mode, int32 pid, int32 submode, int32 vpid, int32 ppid, int32 tid, string
			name, int32 status, int32 vtid -->
		<eventHandler eventName="lttng_statedump_process_state">
			<stateChange>
				<if>
					<condition>
						<constant value="Threads" />
						<eventField name="tid" />
						<constant value="Exec_name" />
						<stateValue type="null" />
					</condition>
				</if>
				<then>
					<constant value="Threads" />
					<eventField name="tid" />
					<constant value="Exec_name" />
					<stateValue eventField="name" />
				</then>
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<constant value="Threads" />
						<eventField name="tid" />
						<constant value="PPID" />
						<stateValue type="null" />
					</condition>
				</if>
				<then>
					<constant value="Threads" />
					<eventField name="tid" />
					<constant value="PPID" />
					<stateValue eventField="ppid" forcedType="int" />
				</then>
			</stateChange>
			<stateChange>
				<if>
					<and>
						<condition>
							<constant value="Threads" />
							<eventField name="tid" />
							<constant value="Status" />
							<stateValue type="null" />
						</condition>
						<condition>
							<field name="status" />
							<stateValue long="2" />
						</condition>
					</and>
				</if>
				<then>
					<constant value="Threads" />
					<eventField name="tid" />
					<constant value="Status" />
					<stateValue int="$PROCESS_STATUS_WAIT_FOR_CPU" />
				</then>
			</stateChange>
			<stateChange>
				<if>
					<and>
						<condition>
							<constant value="Threads" />
							<eventField name="tid" />
							<constant value="Status" />
							<stateValue type="null" />
						</condition>
						<condition>
							<field name="status" />
							<stateValue long="5" />
						</condition>
					</and>
				</if>
				<then>
					<constant value="Threads" />
					<eventField name="tid" />
					<constant value="Status" />
					<stateValue int="$PROCESS_STATUS_WAIT_BLOCKED" />
				</then>
			</stateChange>
			<stateChange>
				<if>
					<condition>
						<constant value="Threads" />
						<eventField name="tid" />
						<constant value="Status" />
						<stateValue type="null" />
					</condition>
				</if>
				<then>
					<constant value="Threads" />
					<eventField name="tid" />
					<constant value="Status" />
					<stateValue int="$PROCESS_STATUS_UNKNOWN" />
				</then>
			</stateChange>
		</eventHandler>
		<!-- case 12 : sched_wakeup : case 13 : sched_wakeup_new : Fields (same
			fields for both types): string comm, int32 tid, int32 prio, int32 success,
			int32 target_cpu -->
		<eventHandler eventName="sched_wakeup*">
			<stateChange>
				<if>
					<and>
						<not>
							<condition>
								<constant value="Threads" />
								<eventField name="tid" />
								<constant value="Status" />
								<stateValue int="$PROCESS_STATUS_RUN_USERMODE" />
							</condition>
						</not>
						<not>
							<condition>
								<constant value="Threads" />
								<eventField name="tid" />
								<constant value="Status" />
								<stateValue int="$PROCESS_STATUS_RUN_SYSCALL" />
							</condition>
						</not>
					</and>
				</if>
				<then>
					<constant value="Threads" />
					<eventField name="tid" />
					<constant value="Status" />
					<stateValue int="$PROCESS_STATUS_WAIT_FOR_CPU" />
				</then>
			</stateChange>
		</eventHandler>
		<!-- delfault : syscall -->
		<eventHandler eventName="sys_*">
			<stateChange>
				<locationName value="CurrentThread" />
				<constant value="System_call" />
				<stateValue type="eventName" />
			</stateChange>
			<stateChange>
				<locationName value="CurrentThread" />
				<constant value="Status" />
				<stateValue int="$PROCESS_STATUS_RUN_SYSCALL" />
			</stateChange>
			<stateChange>
				<locationName value="CurrentCPU" />
				<constant value="Status" />
				<stateValue int="$CPU_STATUS_RUN_SYSCALL" />
			</stateChange>
		</eventHandler>
		<!-- delfault : compat_syscall -->
		<eventHandler eventName="compat_sys_*">
			<stateChange>
				<locationName value="CurrentThread" />
				<constant value="System_call" />
				<stateValue type="eventName" />
			</stateChange>
			<stateChange>
				<locationName value="CurrentThread" />
				<constant value="Status" />
				<stateValue int="$PROCESS_STATUS_RUN_SYSCALL" />
			</stateChange>
			<stateChange>
				<locationName value="CurrentCPU" />
				<constant value="Status" />
				<stateValue int="$CPU_STATUS_RUN_SYSCALL" />
			</stateChange>
		</eventHandler>
	</stateProvider>
</tmfxml>